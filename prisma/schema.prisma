generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String          @id @default(uuid())
  name             String
  email            String          @unique
  phone            String          @unique
  password         String
  role             Role            @default(USER)
  avatar           String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  address          String?
  birthdate        DateTime?
  city             String?
  district         String?
  emailVerified    Boolean         @default(false)
  gender           Gender?
  lastOrderDate    DateTime?
  loyaltyPoints    Int             @default(0)
  newsletter       Boolean         @default(true)
  phoneVerified    Boolean         @default(false)
  smsNotifications Boolean         @default(true)
  totalOrders      Int             @default(0)
  totalSpent       Float           @default(0)
  addresses        Address[]
  carts            Cart[]
  favorites        Favorite[]
  loyaltyRewards   LoyaltyReward[]
  notifications    Notification[]
  orders           Order[]
  reviews          Review[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  label        String
  fullName     String
  phone        String
  address      String
  city         String
  district     String
  landmark     String?
  instructions String?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@index([userId])
  @@map("addresses")
}

model Category {
  id              String    @id @default(uuid())
  name            String    @unique
  description     String?
  slug            String    @unique
  icon            String?
  image           String?
  order           Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  metaDescription String?
  metaTitle       String?
  products        Product[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Product {
  id                String           @id @default(uuid())
  name              String
  description       String?
  price             Float
  likes             Int              @default(0)
  available         Boolean          @default(true)
  stock             Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  categoryId        String?
  allergens         String[]
  calories          Int?
  carbs             Float?
  compareAtPrice    Float?
  costPrice         Float?
  fat               Float?
  ingredients       String?
  lowStockThreshold Int              @default(5)
  metaDescription   String?
  metaTitle         String?
  prepTime          Int?
  protein           Float?
  servings          Int?
  sku               String?          @unique
  views             Int              @default(0)
  weight            Float?
  cartItems         CartItem[]
  favorites         Favorite[]
  orderItems        OrderItem[]
  media             ProductMedia[]
  variants          ProductVariant[]
  category          Category?        @relation(fields: [categoryId], references: [id])
  reviews           Review[]

  @@index([categoryId])
  @@index([sku])
  @@index([available])
  @@map("products")
}

model ProductVariant {
  id        String      @id @default(uuid())
  productId String
  name      String
  type      VariantType
  price     Float
  sku       String?     @unique
  stock     Int         @default(0)
  isDefault Boolean     @default(false)
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_variants")
}

model ProductMedia {
  id         String    @id @default(uuid())
  productId  String
  url        String
  publicId   String
  type       MediaType @default(IMAGE)
  altText    String?
  order      Int       @default(0)
  isFeatured Boolean   @default(false)
  duration   Int?
  size       Int?
  format     String?
  createdAt  DateTime  @default(now())
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([type])
  @@map("product_media")
}

model Review {
  id              String   @id @default(uuid())
  productId       String
  userId          String
  rating          Int
  title           String?
  comment         String?
  isApproved      Boolean  @default(false)
  isVerifiedBuyer Boolean  @default(false)
  helpfulCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

model SpecialOffer {
  id            String       @id @default(uuid())
  title         String
  description   String?
  type          OfferType
  image         String?
  badge         String?
  discountType  DiscountType
  discountValue Float
  minPurchase   Float?
  maxDiscount   Float?
  productIds    String[]
  categoryIds   String[]
  startDate     DateTime
  endDate       DateTime
  usageLimit    Int?
  usageCount    Int          @default(0)
  limitPerUser  Int?
  isActive      Boolean      @default(true)
  priority      Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("special_offers")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String?
  status    CartStatus @default(TEMP)
  name      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  expiresAt DateTime?
  sessionId String?    @unique
  items     CartItem[]
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    Order[]

  @@index([sessionId])
  @@map("carts")
}

model CartItem {
  id         String   @id @default(uuid())
  cartId     String
  productId  String
  quantity   Int      @default(1)
  note       String?
  createdAt  DateTime @default(now())
  priceAtAdd Float?
  updatedAt  DateTime @default(now()) @updatedAt
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id                   String               @id @default(uuid())
  userId               String
  orderNumber          String               @unique
  deliveryName         String
  deliveryPhone        String
  deliveryAddress      String?
  scheduledAt          DateTime?
  status               OrderStatus          @default(PENDING)
  total                Float
  paymentMethod        String?
  isPaid               Boolean              @default(false)
  whatsappSent         Boolean              @default(false)
  notes                String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  cartId               String
  addressId            String?
  cancelReason         String?
  cancelledAt          DateTime?
  deliveredAt          DateTime?
  deliveryCity         String?
  deliveryDistrict     String?
  deliveryFee          Float                @default(0)
  deliveryInstructions String?
  deliveryLandmark     String?
  discount             Float                @default(0)
  estimatedDelivery    DateTime?
  negotiatedTotal      Float?
  negotiationNote      String?
  paidAt               DateTime?
  paymentStatus        PaymentStatus        @default(PENDING)
  subtotal             Float                @default(0)
  tax                  Float                @default(0)
  trackingNumber       String?
  items                OrderItem[]
  statusHistory        OrderStatusHistory[]
  address              Address?             @relation(fields: [addressId], references: [id])
  cart                 Cart                 @relation(fields: [cartId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id])
  sale                 Sale?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id           String  @id @default(uuid())
  orderId      String
  productId    String
  quantity     Int
  price        Float
  note         String?
  productImage String?
  productName  String?
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  status    OrderStatus
  note      String?
  createdBy String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

model Sale {
  id                String   @id @default(uuid())
  orderId           String   @unique
  listPrice         Float
  salePrice         Float
  actualPrice       Float
  costPrice         Float
  deliveryCost      Float    @default(0)
  otherCosts        Float    @default(0)
  grossProfit       Float
  profitMargin      Float
  wasNegotiated     Boolean  @default(false)
  negotiationAmount Float    @default(0)
  negotiationReason String?
  paymentMethod     String
  saleDate          DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([saleDate])
  @@index([wasNegotiated])
  @@map("sales")
}

model Expense {
  id          String            @id @default(uuid())
  category    ExpenseCategory
  description String
  amount      Float
  vendor      String?
  reference   String?
  notes       String?
  isRecurring Boolean           @default(false)
  frequency   ExpenseFrequency?
  receiptUrl  String?
  expenseDate DateTime          @default(now())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([category])
  @@index([expenseDate])
  @@index([isRecurring])
  @@map("expenses")
}

model FinancialGoal {
  id           String     @id @default(uuid())
  type         GoalType
  period       GoalPeriod
  targetValue  Float
  currentValue Float      @default(0)
  startDate    DateTime
  endDate      DateTime
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([period])
  @@index([isActive])
  @@map("financial_goals")
}

model BusinessRecommendation {
  id               String                 @id @default(uuid())
  type             RecommendationType
  priority         RecommendationPriority
  title            String
  description      String
  metrics          Json?
  suggestedActions String[]
  estimatedImpact  String?
  status           RecommendationStatus   @default(PENDING)
  isDismissed      Boolean                @default(false)
  wasImplemented   Boolean                @default(false)
  implementedAt    DateTime?
  adminFeedback    String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  @@index([type])
  @@index([priority])
  @@index([status])
  @@index([isDismissed])
  @@map("business_recommendations")
}

model DailySnapshot {
  id                  String   @id @default(uuid())
  date                DateTime @unique @db.Date
  totalRevenue        Float    @default(0)
  totalOrders         Int      @default(0)
  totalProfit         Float    @default(0)
  averageOrderValue   Float    @default(0)
  totalExpenses       Float    @default(0)
  totalCost           Float    @default(0)
  newCustomers        Int      @default(0)
  returningCustomers  Int      @default(0)
  topSellingProductId String?
  lowStockProducts    Int      @default(0)
  conversionRate      Float    @default(0)
  profitMargin        Float    @default(0)
  createdAt           DateTime @default(now())

  @@index([date])
  @@map("daily_snapshots")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("favorites")
}

model LoyaltyReward {
  id        String    @id @default(uuid())
  userId    String
  points    Int
  reason    String
  orderId   String?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("loyalty_rewards")
}

model Coupon {
  id             String     @id @default(uuid())
  code           String     @unique
  description    String?
  type           CouponType
  value          Float
  minOrderAmount Float?
  maxDiscount    Float?
  usageLimit     Int?
  usageCount     Int        @default(0)
  validFrom      DateTime
  validUntil     DateTime
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([code])
  @@index([validFrom, validUntil])
  @@map("coupons")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model ProductView {
  id        String   @id @default(uuid())
  productId String
  userId    String?
  sessionId String?
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
  @@index([createdAt])
  @@map("product_views")
}

model WhatsAppSchedule {
  id          String              @id @default(uuid())
  message     String
  scheduledAt DateTime
  status      ScheduleStatus      @default(PENDING)
  sentAt      DateTime?
  error       String?
  createdAt   DateTime            @default(now())
  type        WhatsAppMessageType @default(TEXT)
  mediaUrl    String?
  recipients  WhatsAppRecipient[]

  @@map("whatsapp_schedules")
}

model WhatsAppRecipient {
  id         String           @id @default(uuid())
  scheduleId String
  recipient  String
  type       RecipientType
  status     ScheduleStatus   @default(PENDING)
  error      String?
  schedule   WhatsAppSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@map("whatsapp_recipients")
}

model WhatsAppGroup {
  id                String   @id @default(uuid())
  jid               String   @unique
  name              String
  description       String?
  participantsCount Int      @default(0)
  isActive          Boolean  @default(true)
  lastSyncAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([jid])
  @@index([isActive])
  @@map("whatsapp_groups")
}

model AutoReply {
  id         String    @id @default(uuid())
  keyword    String    @unique
  response   String
  isActive   Boolean   @default(true)
  matchType  MatchType @default(CONTAINS)
  priority   Int       @default(0)
  usageCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([keyword])
  @@index([isActive])
  @@map("auto_replies")
}

model WhatsAppContact {
  id               String          @id @default(uuid())
  jid              String          @unique
  name             String?
  phone            String
  pushName         String?
  tags             String[]
  notes            String?
  totalOrders      Int             @default(0)
  totalSpent       Float           @default(0)
  lastOrderDate    DateTime?
  firstMessageDate DateTime?
  lastMessageDate  DateTime?
  messageCount     Int             @default(0)
  isBlocked        Boolean         @default(false)
  isFavorite       Boolean         @default(false)
  segment          CustomerSegment @default(PROSPECT)
  source           String?
  avatarUrl        String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  followUps        FollowUp[]
  messages         Message[]

  @@index([jid])
  @@index([phone])
  @@index([segment])
  @@index([lastMessageDate])
  @@map("whatsapp_contacts")
}

model Message {
  id              String           @id @default(uuid())
  messageId       String           @unique
  conversationId  String
  contactId       String
  type            MessageType
  content         String?
  caption         String?
  mediaUrl        String?
  mediaSize       Int?
  mediaMimeType   String?
  direction       MessageDirection
  isFromMe        Boolean
  status          MessageStatus    @default(SENT)
  readAt          DateTime?
  deliveredAt     DateTime?
  isAutoReply     Boolean          @default(false)
  autoReplyId     String?
  quotedMessageId String?
  isForwarded     Boolean          @default(false)
  timestamp       DateTime         @default(now())
  createdAt       DateTime         @default(now())
  contact         WhatsAppContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([conversationId])
  @@index([timestamp])
  @@index([direction])
  @@index([isAutoReply])
  @@map("messages")
}

model FollowUpTemplate {
  id           String               @id @default(uuid())
  name         String
  description  String?
  trigger      FollowUpTrigger
  delayDays    Int                  @default(0)
  delayHours   Int                  @default(0)
  delayMinutes Int                  @default(0)
  message      String
  mediaUrl     String?
  mediaType    WhatsAppMessageType?
  conditions   Json?
  isActive     Boolean              @default(true)
  priority     Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  followUps    FollowUp[]

  @@index([trigger])
  @@index([isActive])
  @@map("follow_up_templates")
}

model FollowUp {
  id          String           @id @default(uuid())
  contactId   String
  templateId  String
  scheduledAt DateTime
  status      FollowUpStatus   @default(PENDING)
  sentAt      DateTime?
  error       String?
  metadata    Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  contact     WhatsAppContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  template    FollowUpTemplate @relation(fields: [templateId], references: [id])

  @@index([contactId])
  @@index([templateId])
  @@index([scheduledAt, status])
  @@map("follow_ups")
}

enum Role {
  USER
  ADMIN
  SUPER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum VariantType {
  SIZE
  FLAVOR
  COLOR
  CUSTOM
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_DELIVERY
}

enum NotificationType {
  ORDER_CONFIRMED
  ORDER_PREPARING
  ORDER_READY
  ORDER_DELIVERED
  ORDER_CANCELLED
  PROMOTION
  LOYALTY_POINTS
  REVIEW_REQUEST
  SYSTEM
}

enum OfferType {
  FLASH_SALE
  BUNDLE
  BOGO
  DISCOUNT
  FREE_DELIVERY
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum ExpenseCategory {
  RAW_MATERIALS
  PACKAGING
  DELIVERY
  MARKETING
  UTILITIES
  RENT
  SALARIES
  EQUIPMENT
  MAINTENANCE
  INSURANCE
  TAXES
  OTHER
}

enum ExpenseFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum GoalType {
  REVENUE
  PROFIT
  ORDERS
}

enum GoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum RecommendationType {
  PRICING
  INVENTORY
  MARKETING
  PRODUCT
  CUSTOMER_RETENTION
  COST_REDUCTION
  PROMOTION
  SUPPLIER
  STAFFING
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RecommendationStatus {
  PENDING
  REVIEWED
  IMPLEMENTED
  REJECTED
}

enum FollowUpTrigger {
  AFTER_ORDER
  AFTER_PAYMENT
  AFTER_DELIVERY
  AFTER_FIRST_MESSAGE
  AFTER_LAST_MESSAGE
  INACTIVITY
  BIRTHDAY
  CUSTOM
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  POLL
}

enum FollowUpStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum CustomerSegment {
  PROSPECT
  NEW
  REGULAR
  VIP
  INACTIVE
  BLOCKED
}

enum CartStatus {
  TEMP
  SAVED
  FINALIZED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum ScheduleStatus {
  PENDING
  SENT
  FAILED
}

enum RecipientType {
  PRIVATE
  GROUP
}

enum WhatsAppMessageType {
  TEXT
  IMAGE
  VIDEO
  STATUS
}

enum MatchType {
  EXACT
  CONTAINS
  STARTS_WITH
  ENDS_WITH
  REGEX
}

enum MediaType {
  IMAGE
  VIDEO
}
